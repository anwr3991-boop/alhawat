<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† â€“ Ø§Ù„Ù„ÙˆØ§Ø¡ 604</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold:#C9A35E;
      --gold2:#9E7A3A;
      --bg0:#030712;
      --bg1:#071021;
      --bg2:#0b1630;
      --glass: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --strokeGold: rgba(201,163,94,.40);
      --text:#f8fafc;
      --muted:#cbd5e1;
      --shadow: 0 40px 140px rgba(0,0,0,.75);
      --r:26px;

      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Cairo",sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 650px at 25% 20%, rgba(201,163,94,.14), transparent 60%),
        radial-gradient(900px 600px at 80% 80%, rgba(34,197,94,.08), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1), var(--bg2));
    }

    .bg{
      position:fixed; inset:0; pointer-events:none; z-index:0;
    }
    .bg:before{
      content:"";
      position:absolute; inset:-160px;
      background:
        radial-gradient(circle at 20% 35%, rgba(201,163,94,.20), transparent 55%),
        radial-gradient(circle at 80% 70%, rgba(56,189,248,.10), transparent 58%);
      filter: blur(44px);
      opacity:.95;
    }
    .bg:after{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(90deg, rgba(255,255,255,.05) 0 1px, transparent 1px 72px),
        repeating-linear-gradient(0deg, rgba(255,255,255,.04) 0 1px, transparent 1px 72px);
      opacity:.06;
      mask-image: radial-gradient(circle at 50% 50%, rgba(0,0,0,1), rgba(0,0,0,.25) 65%, transparent 85%);
    }

    .stage{
      position:relative;
      z-index:1;
      min-height:100svh;
      padding: clamp(12px, 2.4vw, 24px);
    }

    .container{
      width:min(1100px, 100%);
      margin: 0 auto;
    }

    /* Top Bar */
    .bar{
      border-radius: var(--r);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      position:relative;
      overflow:hidden;
    }
    .bar:before{
      content:"";
      position:absolute; inset:0 0 auto 0;
      height:6px;
      background: linear-gradient(90deg,
        rgba(201,163,94,0),
        rgba(201,163,94,.95),
        rgba(255,255,255,.22),
        rgba(201,163,94,.95),
        rgba(201,163,94,0)
      );
      opacity:.95;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 240px;
    }
    .logo{
      width:50px; height:50px;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(201,163,94,.55);
      background: rgba(255,255,255,.06);
      box-shadow: 0 14px 60px rgba(0,0,0,.55);
      flex: 0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:cover}

    .ttl{
      display:flex; flex-direction:column;
      gap:2px;
    }
    .ttl h1{margin:0;font-size:16px;font-weight:900}
    .ttl .sub{color:rgba(203,213,225,.86);font-size:12px}

    .actions{display:flex; gap:10px; flex-wrap:wrap}

    .btn{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:16px;
      font-family:"Cairo",sans-serif;
      font-weight:900;
      font-size:13px;
      min-height:44px;
      transition:.15s ease;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn.gold{
      color:#0b0b0b;
      background: linear-gradient(135deg, var(--gold), rgba(34,197,94,.16));
      border-color: rgba(201,163,94,.28);
    }
    .btn.red{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.30);
      color:#fee2e2;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    /* Layout */
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
      align-items:start;
    }
    @media(max-width: 980px){
      .grid{grid-template-columns: 1fr;}
    }

    .card{
      border-radius: var(--r);
      border:1px solid var(--stroke);
      background: rgba(15,23,42,.72);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .card h2{
      margin:0 0 10px;
      font-size:15px;
      font-weight:900;
    }

    .warn{
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.10);
      color:#fee2e2;
      padding:12px;
      border-radius:18px;
      line-height:1.9;
      font-size:12px;
      display:none;
    }

    label{display:block;margin:10px 0 6px;color:rgba(203,213,225,.92);font-size:12px}
    input,select{
      width:100%;
      padding:13px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      outline:none;
      font-family:"Cairo",sans-serif;
      font-size:14px;
      transition:.15s ease;
    }
    /* âœ… Fix: Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù€ select ÙƒØ§Ù†Øª Ø¨ÙŠØ¶Ø§Ø¡ ÙˆØ§Ù„Ø®Ø· Ø£Ø¨ÙŠØ¶ */
select{
  background: rgba(255,255,255,.05) !important;
  color: var(--text) !important;
  border: 1px solid rgba(255,255,255,.12);
  -webkit-appearance: none;
  appearance: none;
}

/* Ø³Ù‡Ù… Ø¨Ø³ÙŠØ· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) */
select{
  background-image:
    linear-gradient(45deg, transparent 50%, rgba(255,255,255,.75) 50%),
    linear-gradient(135deg, rgba(255,255,255,.75) 50%, transparent 50%);
  background-position:
    left 18px center,
    left 12px center;
  background-size: 6px 6px, 6px 6px;
  background-repeat: no-repeat;
  padding-left: 42px; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø³Ù‡Ù… */
}

/* âœ… Ø§Ù„Ø£Ù‡Ù…: Ù„ÙˆÙ† Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù†ÙØ³Ù‡Ø§ */
select option{
  background: #0b1630;   /* ØºØ§Ù…Ù‚ */
  color: #f8fafc;        /* Ø£Ø¨ÙŠØ¶ */
}

/* Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ optgroup */
select optgroup{
  background: #071021;
  color: #f8fafc;
}

/* ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ² */
select:focus{
  border-color: rgba(201,163,94,.60);
  box-shadow: 0 0 0 6px rgba(201,163,94,.10);
}

    input::placeholder{color:rgba(203,213,225,.65)}
    input:focus,select:focus{
      border-color: rgba(201,163,94,.60);
      box-shadow: 0 0 0 6px rgba(201,163,94,.10);
    }
    input[readonly]{
      opacity:.85;
      background: rgba(255,255,255,.03);
    }

    .row2{display:grid;grid-template-columns: 1fr 1fr; gap:12px}
    @media(max-width:520px){.row2{grid-template-columns:1fr}}

    .hint{
      margin-top:10px;
      font-size:12px;
      color: rgba(203,213,225,.85);
      line-height:1.8;
      border:1px dashed rgba(255,255,255,.14);
      padding:10px 12px;
      border-radius:18px;
      background: rgba(255,255,255,.03);
    }

    /* Users Table */
    .topTools{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .search{
      flex:1;
      min-width: 240px;
      position:relative;
    }
    .search input{
      padding-right:14px;
      padding-left:44px;
    }
    .search span{
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      width:32px;height:32px;
      border-radius:12px;
      display:grid;place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.92);
      pointer-events:none;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
    }
    thead th{
      text-align:right;
      font-size:12px;
      color: rgba(203,213,225,.92);
      padding:10px 12px;
      background: rgba(255,255,255,.05);
      border-bottom:1px solid rgba(255,255,255,.08);
      white-space:nowrap;
    }
    tbody td{
      padding:10px 12px;
      font-size:13px;
      color: rgba(248,250,252,.95);
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:middle;
    }
    tbody tr{
      background: rgba(255,255,255,.02);
      cursor:pointer;
      transition:.12s ease;
    }
    tbody tr:hover{background: rgba(201,163,94,.08)}
    tbody tr.active{outline:2px solid rgba(201,163,94,.40); background: rgba(201,163,94,.10)}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-size:12px;
      color: rgba(203,213,225,.92);
      white-space:nowrap;
    }
    .pill.ok{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.08); color:#d1fae5}
    .pill.bad{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.08); color:#fee2e2}

    .msg{
      margin-top:12px;
      padding:10px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size:12px;
      display:none;
      line-height:1.9;
    }
    .msg.show{display:block}
    .msg.ok{border-color:rgba(34,197,94,.55);color:#d1fae5}
    .msg.bad{border-color:rgba(239,68,68,.55);color:#fee2e2}
    .msg.warn{border-color:rgba(245,158,11,.55);color:#fff7ed}
  </style>
</head>

<body>
  <div class="bg"></div>

  <div class="stage">
    <div class="container">

      <div class="bar">
        <div class="brand">
          <div class="logo"><img src="604.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù„ÙˆØ§Ø¡"></div>
          <div class="ttl">
            <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (ADMIN)</h1>
            <div class="sub">Ø¥Ø¶Ø§ÙØ© â€¢ ØªØ¹Ø¯ÙŠÙ„ â€¢ Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Google Sheet</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" onclick="location.href='staff.html'">Ø±Ø¬ÙˆØ¹ </button>
          <button class="btn gold" id="refreshBtn">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
          <button class="btn red" id="clearBtn">ØªÙØ±ÙŠØº Ø§Ù„ÙÙˆØ±Ù…</button>
        </div>
      </div>

      <div class="grid">

        <!-- Form Card -->
        <div class="card">
          <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>

          <div class="warn" id="noAccess">ğŸš« Ù…Ø§ Ø¹Ù†Ø¯ÙƒØ´ ØµÙ„Ø§Ø­ÙŠØ© ADMIN Ù„Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØµÙØ­Ø© Ù‡Ø°ÙŠ.</div>

          <div id="adminArea">
            <div class="row2">
              <div>
                <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (user_id)</label>
                <input id="user_id" placeholder="ÙŠØªÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹â€¦" readonly>
              </div>
              <div>
                <label>Ø§Ù„Ø­Ø§Ù„Ø© (is_active)</label>
                <select id="is_active">
                  <option value="TRUE">TRUE (Ù†Ø´Ø·)</option>
                  <option value="FALSE">FALSE (ØºÙŠØ± Ù†Ø´Ø·)</option>
                </select>
              </div>
            </div>

            <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (full_name)</label>
            <input id="full_name" placeholder="Ù…Ø«Ø§Ù„: Ø£ÙŠÙˆØ¨ Ø§Ù„Ø­ÙˆØ§Øª">

            <div class="row2">
              <div>
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (username)</label>
                <input id="username" placeholder="Ù…Ø«Ø§Ù„: ayoub">
              </div>
              <div>
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (password)</label>
                <input id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
              </div>
            </div>

            <div class="row2">
              <div>
                <label>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (role)</label>
                <select id="role">
                  <option value="ADMIN">ADMIN</option>
                  <option value="OPERATOR">OPERATOR</option>
                  <option value="REPORTS">REPORTS</option>
                  <option value="VIEWER">VIEWER</option>
                  <option value="STAFF">STAFF</option>
                </select>
              </div>
              <div>
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (note) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="note" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø©â€¦">
              </div>
            </div>

            <div class="row2">
              <div>
                <label>Ø¢Ø®Ø± ÙˆÙ‚Øª (created_at)</label>
                <input id="created_at" readonly>
              </div>
              <div>
                <label>ØªÙ… Ø¨ÙˆØ§Ø³Ø·Ø© (created_by_name)</label>
                <input id="created_by_name" readonly>
              </div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
              <button class="btn gold" id="addBtn" style="flex:1">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
              <button class="btn" id="updateBtn" style="flex:1">âœï¸ ØªØ­Ø¯ÙŠØ«</button>
            </div>

            <div class="hint">
              âœ… ØªØ¶ØºØ· Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙŠÙ…ÙŠÙ†/ØªØ­Øª â†’ ØªØªØ¹Ø¨Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§.  
              ğŸ”’ created_at / created_by_name ØªØªØ³Ø¬Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.
            </div>

            <div class="msg" id="msg"></div>
          </div>
        </div>

        <!-- List Card -->
        <div class="card">
          <div class="topTools">
            <h2 style="margin:0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
            <div class="search">
              <span>ğŸ”</span>
              <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„ÙŠÙˆØ²Ø± / Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©â€¦">
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th style="width:90px">ID</th>
                  <th>Ø§Ù„Ø§Ø³Ù…</th>
                  <th>username</th>
                  <th>role</th>
                  <th style="width:130px">is_active</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="5" style="color:rgba(203,213,225,.85)">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>
              </tbody>
            </table>
          </div>

        </div>

      </div>

    </div>
  </div>

<script>
  // âœ… Ø¹Ø¯Ù‘Ù„Ù‡Ø§ Ù„Ùˆ ØªØ¨Ù‘ÙŠ
  const API_URL = "https://script.google.com/macros/s/AKfycbwfjjD3s2QEXsX22_oCA7x0SMMevFbG-IoWFNrFn0yfnd60ryD9PbKEXa0cM-gMMZh5/exec";

  // JSONP
  function jsonp(params){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      params.callback = cb;
      const s = document.createElement("script");
      s.src = API_URL + "?" + new URLSearchParams(params).toString();
      window[cb] = (data)=>{ resolve(data); delete window[cb]; s.remove(); };
      s.onerror = ()=>{ reject(new Error("JSONP failed")); delete window[cb]; s.remove(); };
      document.body.appendChild(s);
    });
  }

  const user = JSON.parse(localStorage.getItem("fuel_user") || "null");
  if(!user) location.href = "staff-login.html";

  const roleLogged = (user?.role || user?.user_role || "").toString().toUpperCase();
  const adminArea = document.getElementById("adminArea");
  const noAccess = document.getElementById("noAccess");

  if(roleLogged !== "ADMIN" && roleLogged !== "ADMINISTRATOR"){
    adminArea.style.display = "none";
    noAccess.style.display = "block";
  }

  // Ø¹Ù†Ø§ØµØ±
  const el = (id)=>document.getElementById(id);
  const tbody = el("tbody");
  const q = el("q");
  const msg = el("msg");

  const f_user_id = el("user_id");
  const f_full = el("full_name");
  const f_user = el("username");
  const f_pass = el("password");
  const f_role = el("role");
  const f_active = el("is_active");
  const f_note = el("note");
  const f_created_at = el("created_at");
  const f_created_by = el("created_by_name");

  let USERS = [];
  let selectedId = "";

  function setMsg(text, type){
    msg.className = "msg show " + (type || "");
    msg.textContent = text;
  }
  function clearMsg(){ msg.className="msg"; msg.textContent=""; }

  function fmtActive(v){
    const s = String(v||"TRUE").toUpperCase();
    return s === "FALSE"
      ? `<span class="pill bad">FALSE</span>`
      : `<span class="pill ok">TRUE</span>`;
  }

  function normalize(str){ return String(str||"").toLowerCase().trim(); }

  function render(list){
    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="5" style="color:rgba(203,213,225,.85)">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</td></tr>`;
      return;
    }
    tbody.innerHTML = list.map(u=>{
      const active = String(u.is_active||"TRUE").toUpperCase();
      const trClass = (String(u.user_id) === String(selectedId)) ? "active" : "";
      return `
        <tr class="${trClass}" data-id="${u.user_id}">
          <td>${u.user_id ?? ""}</td>
          <td>${u.full_name ?? ""}</td>
          <td>${u.username ?? ""}</td>
          <td><span class="pill">${u.role ?? ""}</span></td>
          <td>${fmtActive(active)}</td>
        </tr>
      `;
    }).join("");

    // click row
    [...tbody.querySelectorAll("tr[data-id]")].forEach(tr=>{
      tr.addEventListener("click", ()=>{
        const id = tr.getAttribute("data-id");
        const u = USERS.find(x => String(x.user_id) === String(id));
        if(u) fillForm(u);
      });
    });
  }

  function fillForm(u){
    selectedId = String(u.user_id||"");
    f_user_id.value = u.user_id ?? "";
    f_full.value = u.full_name ?? "";
    f_user.value = u.username ?? "";
    f_pass.value = u.password ?? "";
    f_role.value = String(u.role || "OPERATOR").toUpperCase();
    f_active.value = String(u.is_active || "TRUE").toUpperCase();
    f_note.value = u.note ?? "";
    f_created_at.value = u.created_at ? String(u.created_at) : "";
    f_created_by.value = u.created_by_name ? String(u.created_by_name) : "";
    render(filterUsers()); // Ù„ØªØ­Ø¯ÙŠØ« ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ
    clearMsg();
  }

  function clearForm(){
    selectedId = "";
    f_user_id.value = "";
    f_full.value = "";
    f_user.value = "";
    f_pass.value = "";
    f_role.value = "OPERATOR";
    f_active.value = "TRUE";
    f_note.value = "";
    f_created_at.value = "";
    f_created_by.value = "";
    render(filterUsers());
    clearMsg();
  }

  function filterUsers(){
    const term = normalize(q.value);
    if(!term) return USERS;
    return USERS.filter(u=>{
      return (
        normalize(u.full_name).includes(term) ||
        normalize(u.username).includes(term) ||
        normalize(u.role).includes(term) ||
        normalize(u.user_id).includes(term)
      );
    });
  }

  async function loadUsers(){
    clearMsg();
    tbody.innerHTML = `<tr><td colspan="5" style="color:rgba(203,213,225,.85)">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>`;
    try{
      const r = await jsonp({ action:"getUsers" });
      if(!r.ok){
        setMsg("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: " + (r.error || ""), "bad");
        tbody.innerHTML = `<tr><td colspan="5" style="color:rgba(203,213,225,.85)">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„.</td></tr>`;
        return;
      }
      USERS = Array.isArray(r.users) ? r.users : [];
      render(filterUsers());
    }catch(e){
      setMsg("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† API_URL Ùˆ Deploy.", "bad");
      tbody.innerHTML = `<tr><td colspan="5" style="color:rgba(203,213,225,.85)">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„.</td></tr>`;
    }
  }

  async function addUser(){
    clearMsg();
    const full_name = f_full.value.trim();
    const username  = f_user.value.trim();
    const password  = f_pass.value.trim();
    const role      = f_role.value.trim();
    const is_active = f_active.value.trim();
    const note      = f_note.value.trim();

    if(!full_name || !username || !password){
      setMsg("Ù„Ø§Ø²Ù… ØªØ¹Ø¨ÙŠ: full_name + username + password", "warn");
      return;
    }

    try{
      const r = await jsonp({
        action:"addUser",
        full_name, username, password, role, is_active, note,
        actor_name: (user.full_name || user.username || "")
      });

      if(!r.ok){
        setMsg("ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: " + (r.error || ""), "bad");
        return;
      }

      setMsg("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ID: " + r.user_id + ")", "ok");
      await loadUsers();
      const created = USERS.find(x => String(x.user_id) === String(r.user_id));
      if(created) fillForm(created);
    }catch(e){
      setMsg("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.", "bad");
    }
  }

  async function updateUser(){
    clearMsg();
    const user_id   = f_user_id.value.trim();
    const full_name = f_full.value.trim();
    const username  = f_user.value.trim();
    const password  = f_pass.value.trim();
    const role      = f_role.value.trim();
    const is_active = f_active.value.trim();
    const note      = f_note.value.trim();

    if(!user_id){
      setMsg("Ø§Ø®ØªØ§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø§Ø¶Ù Ø¬Ø¯ÙŠØ¯.", "warn");
      return;
    }

    try{
      const r = await jsonp({
        action:"updateUser",
        user_id,
        full_name, username, password, role, is_active, note,
        actor_name: (user.full_name || user.username || "")
      });

      if(!r.ok){
        setMsg("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: " + (r.error || ""), "bad");
        return;
      }

      setMsg("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", "ok");
      await loadUsers();
      const updated = USERS.find(x => String(x.user_id) === String(user_id));
      if(updated) fillForm(updated);
    }catch(e){
      setMsg("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.", "bad");
    }
  }

  // Events
  el("refreshBtn").addEventListener("click", loadUsers);
  el("clearBtn").addEventListener("click", clearForm);
  el("addBtn").addEventListener("click", addUser);
  el("updateBtn").addEventListener("click", updateUser);

  q.addEventListener("input", ()=> render(filterUsers()));

  // Start
  loadUsers();
</script>
</body>
</html>
